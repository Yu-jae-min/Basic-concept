# **[23/05/10] NEXT.JS의 이미지 최적화는 어떻게 동작하는가?**

23년 05월 10일

<br>

## **# NEXT.JS의 이미지 최적화는 어떻게 동작하는가?**

AWS 소모임 next.js 이미지최적화 관련 밋업에 참여하였다.
사실 보편적으로 알고 있는 이미지 최적화 방법은 dynamic import 방식을 사용, srcset 속성 활용, Next Image 컴포넌트 사용(이미지 레이지 로드, 캐싱 등), 압축률이 높은 확장자 사용, 컨텐츠 영역에 맞는 이미지 리사이징 등의 방법 등이 있는 것으로 알고 있었다. 그래서 사실 큰 기대는 안했었다. 보편적으로 아는 방법들을 다시 한번 배워본다는 생각으로 참여하게 되었다. 그런데 막상 발표 자료를 들어보니 신선하고 새로운 정보들이 많았다. 간편하게 적용할 수 있지만 큰 효율을 얻을 수 있는 정보들을 얻을 수 있어 좋았다. 해당 밋업에서 발표는 9년차 프론트엔드 개발자이신 **안건환** 개발자님이 진행해주셨다. 발표 내용을 정리해보자.

<br>
<br>

## **1. next/image**

- **img vs next/image** : 아래 이미지에서 볼 수 있듯이 img 태그를 사용할 때와 next/image 컴포넌트를 사용할 때 이미지 파일의 크기는 상당히 많이 차이가 난다.
  <img width="1242" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_01" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/9eb8b246-af83-4f2b-bbe6-1265079d7cad">

- **이미지 최적화 시기와 캐싱** : next/image는 런타임 때 (유저가 이미지 컴포넌트를 뷰포트 안에서 목격할 때, 즉 해당 이미지 최초 요청 시) 이미지 최적화가 발생한다. 그 이후로는 캐싱 된 이미지를 제공한다.

- **외부 이미지** : 외부 저장소에 저장된 이미지도 리사이징 해준다.

- **저장 위치** : dist/cache/images에 최적화된 이미지가 저장된다.

- **확장자 변환** : 이미지가 최적화되면 webp나 avif로 변환된다.

<br>
<br>

## **2. Sharp vs Squoosh**

<img width="1213" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_02" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/f7164cb6-f2fb-4dfe-b374-6fa891ce2176">

Sharp와 Squoosh는 이미지 최적화 라이브러리인데 next/image에서 둘 다 사용 가능하다.
Squoosh는 별도의 설치없이 사용 가능하며 Sharp는 별도의 설치가 필요하다.

<img width="546" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_03" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/da5d7ae1-a693-44a2-bf22-1fa84c9b9099">

next/image 컴포넌트의 기본 로더는 Squoosh를 사용하지만 next 자체에서 Sharp 사용을 강력하게 추천하고 있다. Sharp가 기본 로더가 아닌 이유는 특허 문제로 built-in 되지 않았다고 한다.

<br>

### **2-1. Sharp vs Squoosh 장단점 비교**

|      | Sharp                                                                                                       | Squoosh                           |
| ---- | ----------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 장점 | Squoosh보다 처리 속도가 6배 빠르다.                                                                         | 별도의 설치없이 사용 가능         |
| 단점 | 별도의 설치가 필요하며 설치 시 호환성 이슈가 발생할 수 있다. (M1 칩에서의 이슈였으나 현재 해결됬다고 한다.) | Sharp보다 처리 속도가 6배 느리다. |

<br>

### **2-2. avif**

Alliance for Open Media에서 개발한 이미지 파일 형식으로 압축률이 매우 낮다. 단 Can I Use에서 찾아보면 알 수 있듯이 Edge에서는 사용이 불가능하다.

<img width="1120" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_04" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/94491992-e7fd-457e-95ac-74297b89d576">

그렇다면 avif를 사용하지 못하는 것일까? 결론은 사용할 수 있다. Next.js의 `next/image` 모듈은 기본적으로 지원하는 이미지 형식에 대해 자동으로 변환이 이루어진다. 예를 들어, 웹 브라우저에서 AVIF 형식을 지원하지 않는 경우에는 이미지를 자동으로 JPEG 또는 PNG로 변환하여 제공한다. 변환되는 과정은 `next/image` 가 이미지를 요청할 때 Request Header에 브라우저 별로 사용 가능한 이미지 확장자를 담아 보낸다. 그 후 사용 불가 시 변환하여 호환성 문제를 해결한다. 또한 아래와 같이 `formats` 속성의 확장자 우선 순위를 두어 처리할 수도 있다.

```jsx
import Image from "next/image";

<Image
  src="/path/to/image.avif"
  alt="Image"
  formats={["avif", "jpeg", "png"]}
  width={500}
  height={300}
/>;
```

<br>

### **2-3. Sharp vs Squoosh 이미지 로드 후 크기 비교**

<img width="1271" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_05" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/e6ed1f14-840a-4266-9a81-04805a4b3633">

<img width="1251" alt="NEXTJS의_이미지_최적화는_어떻게_동작하는가_06" src="https://github.com/Yu-jae-min/Basic-concept/assets/85284246/57c56a07-7731-46c0-ba66-ab7a5456d575">

위 결과를 통해 알 수 있듯이 Sharp를 사용하면, webp의 경우 "3~4배", avif의 경우 "3~6배"정도 성능 개선 효과가 있다.

<br>
<br>

## **3. next/image vs CDN**

이미지 최적화를 할 때 next/image 대신 CDN 방식을 활용할 수 있다.
두 가지의 장단점을 비교해보면 아래와 같다.

|      | next/image                                                                                                                                                                                                                                                   | CDN                              |
| ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------- |
| 장점 | Request Header에 브라우저 별로 이미지 확장자 사용 가능 여부를 next에서 알아서 처리해주기 때문에 호환성이 좋다. 예를 들어 Webp가 ios 13 미만 버전에서는 사용이 불가능한데 next/image가 Request Header에 사용 가능한 확장자를 알려주어 호환성 문제가 해결된다. | next/image 대비 트래픽이 적다.   |
| 단점 | CDN 대비 트래픽이 많다. 원본 이미지, 최적화한 이미지 트래픽이 발생한다. 쉽게 생각하면 트래픽이 2배 발생하는 것이다.                                                                                                                                          | next/image 대비 호환성이 나쁘다. |

<br>
<br>

## **# 참여 후기**

이번 밋업에 참여하여 기존에 알고있던 `next/image`가 동작하는 방식과 `sharp`, `avif` 등 이미지 최적화에 있어 필요한 새로운 키워드를 얻을 수 있었다. 이러한 키워드를 얻은 것만으로도 충분히 값진 시간이라고 할 수 있을 것 같다.

<br>
