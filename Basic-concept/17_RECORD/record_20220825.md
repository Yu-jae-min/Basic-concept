# MAT - 671 : 2022/08/25 - 2022/08/31

<br>

## Issue

<br>

- 만 13,14,15,16,17세 유저

  1. 검색결과에서 제외처리

  2. 필터에서 옵션 끌 경우 해당 데이터 포함 표시

## Solution

<br>

- `src/components/form/signUp/player/step1.tsx` : getUtcTime 유틸 함수로 변경

  1. getUtcTime 함수를 사용하여 공통 된 부분 유틸 함수 사용

  ```tsx
  import { getUtcTime } from '~/utils/getUtcTime';

  ...

   const birthDateLimit = new Date(
    new Date(getUtcTime()).setFullYear(
      new Date(getUtcTime()).getFullYear() - 13,
    ),
  );
  ```

<br>

- `src/components/search/playerFilter.tsx`

  1. form onSubmit 이벤트 내부 showUnder 조건 추가 (토글 on/off boolean 값)

  ```tsx
  return (
    <form
      className={css({
        fontWeight: 400,
        lineHeight: "22px",
      })}
      onSubmit={handleSubmit<PlayerFilterForm>((data) => {
        submittedFilterForm.current = { ...data };
        setIsFilterOpen(false);

        const playerFilter = data as PlayerFilterForm;

        const preferredMatchDay =
          playerFilter.preferredMatchDay !== "none"
            ? playerFilter.preferredMatchDay
            : null;

        const preferredLeagueLevel = Object.entries(
          playerFilter.preferredLeagueLevel
        ).reduce((acc, [key, value]) => {
          return value ? [...acc, key as PlayerPreferredLeagueLevel] : [...acc];
        }, [] as PlayerPreferredLeagueLevel[]);

        const mainFoot =
          playerFilter.mainFoot !== "none" ? playerFilter.mainFoot : null;

        const showUnder = playerFilter.showUnder; // 추가

        client.writeQuery({
          query: ReadFilterDocument,
          data: {
            filterLog: {
              lastPlayerFilter: {
                preferredMatchDay,
                preferredLeagueLevel,
                mainFoot,
                showUnder, // 추가
              },
              lastClubFilter: null,
            },
          },
        });
      })}
    >
      ...
    </form>
  );
  ```

  <br>

  2. form 자식 토글 버튼 생성하는 FormField 추가

  ```tsx
  return (
    <form>
      ...
      <FormField
        $style={{
          ...padding("", "", "0px"),
          ...border("bottom", "none"),
          ...flexBox("rowVertical"),
          flexDirection: "row",
          justifyContent: "space-between",
        }}
      >
        <FormFieldLabel>Show Under 18</FormFieldLabel>
        <Controller
          control={control}
          name="showUnder"
          render={({
            field: { value, onChange, ref, ...controlledFields },
          }) => (
            <MAToggle
              size={SIZE.mini}
              checked={value}
              inputRef={ref}
              onChange={(event) => {
                onChange(event);
                setIsDisabled(
                  isEqual(submittedFilterForm.current, getValues())
                );
              }}
              {...controlledFields}
            />
          )}
        />
      </FormField>
      ...
    </form>
  );
  ```

- `src/graphql/local.schema.graphql`

  1. 로컬 스키마 추가

  ```graphql
  type PlayerFilter {
    preferredMatchDay: PlayerPreferredMatchDay
    preferredLeagueLevel: [PlayerPreferredLeagueLevel!]
    mainFoot: PlayerMainFoot
    showUnder: Boolean // 추가
  }
  ```

- `src/pages/search/__operations__/readFilter.graphql`

  1. 쿼리 추가

  ```graphql
  query ReadFilter {
    filterLog {
      lastPlayerFilter {
        preferredMatchDay
        preferredLeagueLevel
        mainFoot
        showUnder // 추가
      }
      lastClubFilter {
        teams {
          firstTeam
          reserves
          u23
          vets
          a
          b
          walking
          disability
        }
        isFACertified
        hasAcademy
      }
    }
  }
  ```

- `src/pages/search/result/index.tsx`

  1. 필터 폼의 타입을 체크하는 PlayerFilterForm에 showUnder 추가

  ```tsx
  type PlayerFilterForm = {
    preferredMatchDay: PlayerPreferredMatchDay | "none";
    preferredLeagueLevel: {
      [index in PlayerPreferredLeagueLevel as string]: boolean;
    };
    mainFoot: PlayerMainFoot | "none";
    showUnder: boolean;
  };
  ```

  2. 필터 폼을 체크하여 필터 처리하는 filterPlayerResults 함수에 조건 추가

  ```tsx
  const filterPlayerResults = ({
    results,
    form,
  }: {
    results: Player[];
    form: PlayerFilterForm;
  }) => {
    const {
      preferredMatchDay: checkedPreferredMatchDay,
      preferredLeagueLevel,
      mainFoot: checkedMainFoot,
      showUnder: checkedShowUnder, // 추가 : 필터링 조건을 추가하기 위해 사용할 boolean 값인 showUnder 사용
    } = form;

    const checkedPreferredLeagueLevel = Object.entries(preferredLeagueLevel)
      .filter(([_, value]) => value)
      .reduce((prev, [key]) => {
        return [...prev, key];
      }, [] as string[]);

    return [
      ...results.filter(
        ({
          preferredMatchDay,
          preferredLeagueLevel: _preferredLeagueLevel,
          mainFoot,
          birth, // 추가 : 나이를 체크하기 위해 유저 brith 사용
        }) => {
          const preferredMatchDayFilter =
            checkedPreferredMatchDay !== "none"
              ? preferredMatchDay === checkedPreferredMatchDay
              : true;

          const preferredLeagueLevelFilter =
            checkedPreferredLeagueLevel.length > 0
              ? checkedPreferredLeagueLevel.includes(_preferredLeagueLevel)
              : true;

          const mainFootFilter =
            checkedMainFoot !== "none" ? mainFoot === checkedMainFoot : true;

          const showUnderFilter =
            checkedShowUnder || filterPlayerAgeResults(birth); // 추가 : 필터링 조건 추가

          return (
            preferredMatchDayFilter &&
            preferredLeagueLevelFilter &&
            mainFootFilter &&
            showUnderFilter // 추가 : 필터링 조건 추가
          );
        }
      ),
    ];
  };
  ```

  3. 필터 폼의 초기 값으로 사용되는 initialPlayerFilterForm에 showUnder 추가 및 초기 값 설정, 이 때 토글 디폴트 값은 만 13세 미만을 필터 처리하는 off가 디폴트이므로 false가 초기 값이 된다.

  ```tsx
  const initialPlayerFilterForm: PlayerFilterForm = {
    preferredMatchDay: "none",
    preferredLeagueLevel: {
      STEP1_2: false,
      STEP3_4: false,
      STEP5_6: false,
      STEP6BELOW: false,
      ALL: false,
    },
    mainFoot: "none",
    showUnder: false, // 추가
  };
  ```

  4. 초기 값을 가져오는 readInitialPlayerFilter return 값에 showUnder 추가

  ```tsx
  const readInitialPlayerFilter = (
    client: ApolloClient<object>,
    isPrevPageDetail: boolean,
  ): PlayerFilterForm => {
  const cache = client.readQuery({
    query: ReadFilterDocument,
  });

  if (
    !isNull(cache) &&
    !isNull(cache.filterLog.lastPlayerFilter) &&
    !isUndefined(cache.filterLog.lastPlayerFilter) &&
    isPrevPageDetail
  ) {
    const {
      filterLog: { lastPlayerFilter },
    } = cache;

    return {
      preferredMatchDay: lastPlayerFilter.preferredMatchDay || 'none',
      mainFoot: lastPlayerFilter.mainFoot || 'none',
      showUnder: lastPlayerFilter.showUnder, // 추가
      preferredLeagueLevel: lastPlayerFilter.preferredLeagueLevel
        ? lastPlayerFilter.preferredLeagueLevel.reduce((acc, val) => {
            return {
              ...acc,
              [val]: true,
            };
          }, {} as { [index in PlayerPreferredLeagueLevel]: boolean })
        : initialPlayerFilterForm.preferredLeagueLevel,
    } as PlayerFilterForm;
  }
  ```

  5. 첫 검색 결과 노출 시 나이가 필터링 안되는 문제를 해결하기 위해 조건 추가, 현재 폼 값이 초기 폼 값과 같을 경우 age 필터가 돌도록 함, 기존 필터와 동시에 트리거 안되도록 설정

  ```tsx
    const filteredResults = useMemo<Result[]>(() => {
      ...
        if (
          isEqual(submittedFilterForm.current, initialPlayerFilterForm) &&
          isPlayerFilterForm(submittedFilterForm.current) &&
          !submittedFilterForm.current.showUnder
        ) {
          toBeFilteredResults = toBeFilteredResults.filter(({ birth }) => {
            return filterPlayerAgeResults(birth);
          });
        }
      ...
    }, [filteredResults])
  ```

- `src/utils/getUtcTime.ts`

  1. UTC Time을 return하는 getUtcTime 유틸 함수 추가

  ```ts
  const getUtcTime = () => {
    const localTime = new Date();
    const offset = localTime.getTimezoneOffset();

    return new Date(
      new Date(
        localTime.setMinutes(
          offset
            ? localTime.getMinutes() + offset
            : localTime.getMinutes() - Math.abs(offset)
        )
      )
    );
  };

  export { getUtcTime };
  ```
